<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–æ–∫</title>

    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 50px;
            background-color: #f4f4f9;
        }

        .form-container {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            width: 300px;
            margin-bottom: 40px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 10px;
            background: #4CAF50;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }

        button:hover {
            background: #45a049;
        }

        #feed {
            width: 500px;
            max-width: 100%;
        }

        .post {
            background: white;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        .time {
            font-size: 12px;
            color: gray;
        }

        .like-btn {
            margin-top: 10px;
            background: #2196F3;
        }

        .like-btn:hover {
            background: #1976D2;
        }
    </style>
</head>

<body>

<div class="form-container">
    <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</h3>
    <form id="feedbackForm">
        <input type="text" id="username" placeholder="–í–∞—à–µ –∏–º—è" required>
        <input type="email" id="userEmail" placeholder="–í–∞—à Email" required>
        <button type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    </form>
</div>

<div id="feed"></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAnalytics, logEvent } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-analytics.js";
    import {
        getFirestore,
        addDoc,
        collection,
        serverTimestamp,
        onSnapshot,
        query,
        orderBy,
        doc,
        updateDoc,
        increment
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js";

    import {
        getAuth,
        signInWithEmailAndPassword,
        signOut,
        onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";


    const firebaseConfig = {
        apiKey: "AIzaSyBVbhWbVDyhWGqC4x176LpjzSnrTE_rKe0",
        authDomain: "gf-8654a.firebaseapp.com",
        projectId: "gf-8654a",
        storageBucket: "gf-8654a.firebasestorage.app",
        messagingSenderId: "716147853392",
        appId: "1:716147853392:web:f87336c7a9378fb93f6955",
        measurementId: "G-7HJ13ZP986"
    };

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);   // üî• Analytics
    const db = getFirestore(app);
    const auth = getAuth(app);             // üîê Auth

    // ===============================
    // 1Ô∏è‚É£ ANALYTICS (—Å–æ–±—ã—Ç–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏)
    // ===============================

    document.getElementById("feedbackForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const nameInput = document.getElementById("username").value;
        const emailInput = document.getElementById("userEmail").value;

        try {
            await addDoc(collection(db, "requests"), {
                name: nameInput,
                email: emailInput,
                likes: 0,
                timestamp: serverTimestamp()
            });

            // üî• –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–±—ã—Ç–∏–µ –≤ Analytics
            logEvent(analytics, "form_submitted", {
                user_name: nameInput
            });

            alert("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
            document.getElementById("feedbackForm").reset();

        } catch (error) {
            console.error("–û—à–∏–±–∫–∞:", error);
            alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏.");
        }
    });

    // ===============================
    // 2Ô∏è‚É£ FIREBASE AUTH (–í—Ö–æ–¥)
    // ===============================

    window.loginUser = async () => {
        const email = prompt("–í–≤–µ–¥–∏—Ç–µ email");
        const password = prompt("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");

        try {
            await signInWithEmailAndPassword(auth, email, password);
            alert("–í—ã –≤–æ—à–ª–∏ –≤ —Å–∏—Å—Ç–µ–º—É!");
        } catch (error) {
            alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: " + error.message);
        }
    };

    // –í—ã—Ö–æ–¥
    window.logoutUser = async () => {
        await signOut(auth);
        alert("–í—ã –≤—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã");
    };

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:", user.email);
        } else {
            console.log("–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω");
        }
    });

    // ===============================
    // –õ–ê–ô–ö
    // ===============================

    window.processLike = async (id) => {
        const docRef = doc(db, "requests", id);
        await updateDoc(docRef, {
            likes: increment(1)
        });
    };

    // ===============================
    // –†–ï–ê–õ–¨–ù–û–ï –í–†–ï–ú–Ø
    // ===============================

    const q = query(collection(db, "requests"), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
        const feed = document.getElementById("feed");
        feed.innerHTML = "";

        snapshot.forEach((docItem) => {
            const data = docItem.data();

            feed.innerHTML += `
                <div class="post">
                    <span class="time">
                        ${data.timestamp?.toDate().toLocaleString() || "..."}
                    </span>
                    <p><strong>${data.name}</strong></p>
                    <p>${data.email}</p>

                    <button class="like-btn" onclick="processLike('${docItem.id}')">
                        üëç ${data.likes || 0}
                    </button>

                    <button onclick="loginUser()" 
                        style="margin-top:8px;background:#673AB7;">
                        üîê –í–æ–π—Ç–∏
                    </button>

                    <button onclick="logoutUser()" 
                        style="margin-top:8px;background:#f44336;">
                        üö™ –í—ã–π—Ç–∏
                    </button>
                </div>
            `;
        });
    });

</script>

</body>
</html>
